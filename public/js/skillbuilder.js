
var assassin = {
    "10800001": {
        "title": "Lucky Stars",
        "level": "10",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800011": {
        "title": "Shadow Cutter",
        "level": "10",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800021": {
        "title": "Fragmented Star",
        "level": "10",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800031": {
        "title": "Shadow Burst",
        "level": "22",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800041": {
        "title": "Fatal Strikes",
        "level": "16",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800051": {
        "title": "Dark Cloak",
        "level": "13",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800061": {
        "title": "Shadow Web",
        "level": "37",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800071": {
        "title": "Dash",
        "level": "1",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800081": {
        "title": "Shadow Chaser",
        "level": "1",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800091": {
        "title": "Mark of Death",
        "level": "25",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800101": {
        "title": "Star Flurry",
        "level": "28",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800111": {
        "title": "Thrown Weapon Mastery",
        "level": "40",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800121": {
        "title": "Star Chaser",
        "level": "19",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800131": {
        "title": "Death Sentence",
        "level": "34",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800141": {
        "title": "Soul Grind",
        "level": "31",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800151": {
        "title": "Shadow Arts",
        "level": "43",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10800161": {
        "title": "Mirror Image: Dark Blade",
        "level": "46",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "20000001": {
        "title": "Swift Swim",
        "level": "1",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "20000011": {
        "title": "Wall Climbing",
        "level": "1",
        "job": "Assassin",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    }
}
var runeblade = {
    "10900001": {
        "title": "Flame Sigil",
        "level": "10",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900011": {
        "title": "Frost Sigil",
        "level": "22",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900021": {
        "title": "Storm Sigil",
        "level": "34",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900031": {
        "title": "Flurry",
        "level": "10",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900041": {
        "title": "Rune Balance",
        "level": "1",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900051": {
        "title": "Blink",
        "level": "1",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900061": {
        "title": "Whirling Blades",
        "level": "13",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900071": {
        "title": "Impact",
        "level": "19",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900081": {
        "title": "Gravity Rune",
        "level": "16",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900091": {
        "title": "Warding Rune",
        "level": "28",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900101": {
        "title": "Blade Chasm",
        "level": "43",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900111": {
        "title": "Illusory Blades",
        "level": "25",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900121": {
        "title": "Rune Focus",
        "level": "31",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900131": {
        "title": "Elemental Potency",
        "level": "40",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900141": {
        "title": "Blade Mastery",
        "level": "37",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900151": {
        "title": "Echoing Blade",
        "level": "10",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "10900161": {
        "title": "Honing Runes",
        "level": "46",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "20000001": {
        "title": "Swift Swim",
        "level": "1",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    },
    "20000011": {
        "title": "Wall Climbing",
        "level": "1",
        "job": "Runeblade",
        "min": "",
        "max": "",
        "locked": "",
        "unlockAt": {}
    }
}

var build;
var no_count = 0;
if (Cookies.get('ms2-build-' + class_name))
    build = JSON.parse(Cookies.get('ms2-build-' + class_name))
else
    build = JSON.parse(JSON.stringify(buildTemplate))


$("[name='btn']").click(event => addPoints(event.target.getAttribute('data-skillid')));
$("[name='typeRadio']").click(event => $('#buildtype').text(event.target.getAttribute('value')));
$("[name='-btn']").click(event => removePoints(event.target.getAttribute('data-skillid')));
$("#resetbuildbtn").click(() => resetBuild());
$("#cmLauncher").click(() => renderCanvas());

var renderedCanvas;
$(document).ready(() => {
    noCount();
    $('.level_cell, .level_cell_sp').addClass('bg-light');
    loadBuild();

})

function renderCanvas() {
    html2canvas(document.querySelector("#render-skill-pane"), { width: 672, onclone: canvasPNG => editElements(canvasPNG) }).then(canvas => {
        $('#renderedCanvas').replaceWith(canvas);
    });
}

function loadBuild() {
    $.each(build, (index, value) => {
        $('#max-points').text(build.max_points);
        $('#max-points-cap').text(buildTemplate.max_points);
        $('#point-' + index).text(" " + build[index].min);
        $('#point-max-' + index).text(build[index].max + " ");
        if (build[index].locked) lockSkill(index);
    });
    toggleButtons();
    saveInCookie();
}

function addPoints(skillid) {
    if (build[skillid].min < buildTemplate[skillid].max && build.max_points > 0) {
        build[skillid].min++;
        updateMaxPoints();
        pointsAction(skillid);
    }
}

function removePoints(skillid) {
    if (build[skillid].min > buildTemplate[skillid].min && build.max_points <= 58) {
        build[skillid].min--;
        updateMaxPoints();
        pointsAction(skillid)
    }
}

function checkLocks(skillid) {
    if (build[skillid].unlockAt) {
        $.each(build[skillid].unlockAt, (index, value) => {
            if (build[index].min >= value) {
            } else if (Math.abs(build[index].min - value) <= build.max_points) {
                updateMaxPoints()
                build[index].min = value;
                unlockSkill(index);
            }
        });
    }
}

function checkLocksAll() {
    $.each(build, (index, value) => {
        if (build[index].unlockAt) {
            var i = 0;
            var check = 0;
            $.each(build[index].unlockAt, (subindex, value) => {
                if (build[subindex].min >= value) {
                    i++;
                    check++;
                } else {
                    check--;
                }
            });
            if (i === check) unlockSkill(index)
            else lockSkill(index)
        }
    })
}

function lockSkill(skillid) {
    build[skillid].locked = true;
    updateMaxPoints();
    build[skillid].min = 0;
    $('#lock-' + skillid).addClass('locked');
}

function unlockSkill(skillid) {
    build[skillid].locked = false;
    $('#lock-' + skillid).removeClass('locked');
}

function updateMaxPoints() {
    let i = -no_count;
    $.each(build, (index, value) => {
        if (build[index].min) {
            i += build[index].min
        }
    })
    build.max_points = buildTemplate.max_points - i;
    $('#max-points').text(build.max_points);
}

function pointsAction(skillid) {
    checkLocks(skillid);
    checkLocksAll();
    loadBuild();
}

function toggleButtons() {
    $.each(build, (index, value) => {
        if (build[index].min === buildTemplate[index].min && build[index].min === buildTemplate[index].max) {
            $('button[name="btn"][data-skillid="' + index + '"]').attr("disabled", "disabled");
            $('button[name="-btn"][data-skillid="' + index + '"]').attr("disabled", "disabled");
        } else if (build[index].min === buildTemplate[index].min) {
            $('button[name="btn"][data-skillid="' + index + '"]').removeAttr("disabled");
            $('button[name="-btn"][data-skillid="' + index + '"]').attr("disabled", "disabled");
        } else if (build[index].min === buildTemplate[index].max) {
            $('button[name="-btn"][data-skillid="' + index + '"]').removeAttr("disabled");
            $('button[name="btn"][data-skillid="' + index + '"]').attr("disabled", "disabled");
        } else {
            $('button[name="-btn"][data-skillid="' + index + '"]').removeAttr("disabled");
            $('button[name="btn"][data-skillid="' + index + '"]').removeAttr("disabled");
        }
        if (build[index].unlockAt) {
            var sum = 0;
            $.each(build[index].unlockAt, (subindex, value) => {
                sum += value;
            })
            if (sum > (build.max_points - 1) && build[index].locked === true) {
                $('button[name="btn"][data-skillid="' + index + '"]').attr("disabled", "disabled");
            }
        }
    })
    if (build.max_points === 0) {
        $('[name="btn"]').attr("disabled", "disabled");
    }

}

function resetBuild() {
    build = JSON.parse(JSON.stringify(buildTemplate))
    loadBuild()
}

function saveInCookie() {
    Cookies.set("ms2-build-" + class_name, JSON.stringify(build));
}

function editElements(canvasPNG) {
    $($(canvasPNG).find('#resetbuildbtn')).hide();
    $($(canvasPNG).find('.skill_btn')).hide();
    $($(canvasPNG).find('#as')).text('MS2WORLD.NET').removeClass('text-muted').addClass('font-weight-bold ml-3');

}

function noCount() {
    let i = 0;
    $.each(buildTemplate, (index, value) => {
        if (buildTemplate[index].min) {
            i += buildTemplate[index].min
        }
    })
    no_count = i;
}
